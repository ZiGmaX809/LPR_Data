name: LPR Data Management

# å®šæ—¶è¿è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼ˆUTCæ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰
# ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒå¤šç§æ›´æ–°æ¨¡å¼
on:
  schedule:
    - cron: '0 2 * * *'  # UTCæ—¶é—´æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      update_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: false
        type: choice
        options:
          - force
          - incremental
          - quality-check
        default: force
  push:
    paths:
      - 'lpr_scraper.py'
      - 'lpr_scraper_integrated.py'
      - '.github/workflows/update-lpr-data.yml'

jobs:
  update-lpr-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      actions: read    # å…è®¸è¯»å– actions
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Determine update mode
      id: mode
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          # å®šæ—¶è§¦å‘ä½¿ç”¨å¢é‡æ¨¡å¼
          echo "mode=incremental" >> $GITHUB_OUTPUT
          echo "description=å®šæ—¶å¢é‡æ›´æ–°" >> $GITHUB_OUTPUT
        elif [ -n "${{ github.event.inputs.update_mode }}" ]; then
          # æ‰‹åŠ¨è§¦å‘ä½¿ç”¨æŒ‡å®šæ¨¡å¼
          echo "mode=${{ github.event.inputs.update_mode }}" >> $GITHUB_OUTPUT
          echo "description=æ‰‹åŠ¨${{ github.event.inputs.update_mode }}æ¨¡å¼" >> $GITHUB_OUTPUT
        else
          # é»˜è®¤å¼ºåˆ¶æ›´æ–°
          echo "mode=force" >> $GITHUB_OUTPUT
          echo "description=é»˜è®¤å¼ºåˆ¶æ›´æ–°" >> $GITHUB_OUTPUT
        fi

    - name: Run LPR data operation
      run: |
        echo "ğŸš€ LPRæ•°æ®ç®¡ç†å·¥å…· - è¿è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“ æ“ä½œæ¨¡å¼: ${{ steps.mode.outputs.description }}"

        case "${{ steps.mode.outputs.mode }}" in
          "force")
            echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ•°æ®..."
            python lpr_scraper_integrated.py --force
            ;;
          "incremental")
            echo "ğŸ“Š å¢é‡æ›´æ–°æ•°æ®..."
            python lpr_scraper_integrated.py --incremental-only
            ;;
          "quality-check")
            echo "ğŸ” ä»…æ‰§è¡Œè´¨é‡æ£€æŸ¥..."
            python lpr_scraper_integrated.py --incremental-only || echo "è´¨é‡æ£€æŸ¥å®Œæˆ"
            ;;
          *)
            echo "â“ æœªçŸ¥æ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤å¼ºåˆ¶æ›´æ–°"
            python lpr_scraper_integrated.py --force
            ;;
        esac

    - name: List generated files
      run: |
        echo "å®Œæ•´æ•°æ®æ–‡ä»¶ï¼š"
        ls -la LPR_Data.* || echo "æœªæ‰¾åˆ°LPR_Dataæ–‡ä»¶"

        if [ -f "LPR_Data.json" ]; then
          echo "JSONæ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
          head -10 LPR_Data.json
        else
          echo "JSONæ–‡ä»¶æœªç”Ÿæˆ"
        fi

    - name: List yearly data files
      run: |
        echo "æŒ‰å¹´ä»½åˆ†å‰²çš„æ–‡ä»¶ï¼š"
        if [ -d "yearly_data" ]; then
          ls -la yearly_data/
          echo "å¹´ä»½æ•°æ®ç»Ÿè®¡ï¼š"
          for file in yearly_data/LPR_Data_*.csv; do
            if [ -f "$file" ]; then
              year=$(basename "$file" .csv | cut -d'_' -f3)
              count=$(tail -n +2 "$file" | wc -l)
              echo "$year å¹´: $count æ¡è®°å½•"
            fi
          done
        else
          echo "yearly_data ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: Perform quality check
      run: |
        echo ""
        echo "ğŸ” æ‰§è¡Œæ•°æ®è´¨é‡æ£€æŸ¥..."

        # æ£€æŸ¥ä¸»æ•°æ®æ–‡ä»¶
        if [ -f "LPR_Data.csv" ]; then
          total_records=$(tail -n +2 LPR_Data.csv | wc -l)
          first_date=$(tail -n +2 LPR_Data.csv | tail -1 | cut -d',' -f1)
          last_date=$(tail -n +2 LPR_Data.csv | head -1 | cut -d',' -f1)
          echo "âœ… ä¸»æ•°æ®æ–‡ä»¶: $total_records æ¡è®°å½• ($first_date è‡³ $last_date)"
        else
          echo "âŒ ä¸»æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
        fi

        # æ£€æŸ¥å¹´ä»½æ•°æ®
        if [ -d "yearly_data" ]; then
          yearly_files=(yearly_data/LPR_Data_*.csv)
          yearly_count=0
          for file in "${yearly_files[@]}"; do
            if [ -f "$file" ]; then
              yearly_count=$((yearly_count + 1))
            fi
          done
          echo "âœ… å¹´ä»½æ•°æ®æ–‡ä»¶: $yearly_count ä¸ªå¹´ä»½"

          # æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
          if [ -f "LPR_Data.csv" ]; then
            main_records=$(tail -n +2 LPR_Data.csv | wc -l)
            yearly_records=0
            for file in "${yearly_files[@]}"; do
              if [ -f "$file" ]; then
                count=$(tail -n +2 "$file" | wc -l)
                yearly_records=$((yearly_records + count))
              fi
            done

            if [ $main_records -eq $yearly_records ]; then
              echo "âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
            else
              echo "âš ï¸ æ•°æ®ä¸ä¸€è‡´: ä¸»æ–‡ä»¶ $main_records æ¡ï¼Œå¹´ä»½æ–‡ä»¶æ€»è®¡ $yearly_records æ¡"
            fi
          fi
        else
          echo "âŒ å¹´ä»½æ•°æ®ç›®å½•ä¸å­˜åœ¨"
        fi
    
    - name: Check for changes
      id: check_changes
      run: |
        # æ·»åŠ æ–°æ–‡ä»¶åˆ°gitè·Ÿè¸ª
        git add LPR_Data.txt LPR_Data.json LPR_Data.csv || true
        git add yearly_data/ || true

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–ï¼ˆåŒ…æ‹¬æ–°æ–‡ä»¶ï¼‰
        if git diff --cached --exit-code --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å˜åŒ–"
          git diff --cached --name-only
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

        # æäº¤å˜æ›´ï¼ˆæ–‡ä»¶å·²åœ¨ä¸Šä¸€æ­¥æ·»åŠ ï¼‰
        git commit -m "ğŸ¤– LPRæ•°æ®ç®¡ç† - $BEIJING_TIME

        æ¨¡å¼: ${{ steps.mode.outputs.description }}

        ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: Claude <noreply@anthropic.com>"

        # æ¨é€åˆ°ä»“åº“
        git push
    
    - name: Upload LPR data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lpr-data-${{ github.run_number }}
        path: |
          LPR_Data.txt
          LPR_Data.json
          LPR_Data.csv
          yearly_data/
        retention-days: 30
    
    - name: Create release on significant updates
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # æ£€æŸ¥æ˜¯å¦æ˜¯é‡è¦æ›´æ–°ï¼ˆæ¯”å¦‚æ–°å¢äº†æ•°æ®è®°å½•ï¼‰
        if [ -f "LPR_Data.json" ]; then
          RECORD_COUNT=$(python -c "import json; data=json.load(open('LPR_Data.json')); print(len(data['data']))")
          echo "Current record count: $RECORD_COUNT"

          # å¦‚æœè®°å½•æ•°é‡æ˜¯5çš„å€æ•°ï¼Œåˆ›å»ºä¸€ä¸ªreleaseï¼ˆå¯é€‰ï¼‰
          if [ $((RECORD_COUNT % 5)) -eq 0 ]; then
            echo "Creating release for milestone: $RECORD_COUNT records"
            # è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºreleaseçš„é€»è¾‘
          fi
        fi

    - name: Sync files to Alibaba Cloud ECS
      # ä»…åœ¨æœ‰æ•°æ®å˜åŒ–æ—¶åŒæ­¥åˆ°æœåŠ¡å™¨
      if: steps.check_changes.outputs.changes == 'true'
      env:
        ECS_HOST: ${{ secrets.ECS_HOST }}
        ECS_PORT: ${{ secrets.ECS_PORT || '22' }}
        ECS_USER: ${{ secrets.ECS_USER }}
        ECS_SSH_KEY: ${{ secrets.ECS_SSH_KEY }}
      run: |
        echo "ğŸ“¡ æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥åˆ°é˜¿é‡Œäº‘ ECS..."

        # æ£€æŸ¥å¿…è¦çš„ Secrets æ˜¯å¦é…ç½®ï¼Œæœªé…ç½®åˆ™è·³è¿‡
        if [ -z "$ECS_HOST" ] || [ -z "$ECS_USER" ] || [ -z "$ECS_SSH_KEY" ]; then
          echo "â­ï¸  ECS åŒæ­¥æœªé…ç½®ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          echo "ğŸ’¡ å¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨ GitHub ä»“åº“ Settings > Secrets ä¸­é…ç½®ï¼š"
          echo "   - ECS_HOST"
          echo "   - ECS_PORT (å¯é€‰ï¼Œé»˜è®¤ 22)"
          echo "   - ECS_USER"
          echo "   - ECS_SSH_KEY"
          exit 0
        fi

        echo "ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°é˜¿é‡Œäº‘ ECS..."

        # è®¾ç½® SSH å¯†é’¥
        mkdir -p ~/.ssh
        echo "$ECS_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p $ECS_PORT -H $ECS_HOST >> ~/.ssh/known_hosts 2>/dev/null

        # ç›®æ ‡è·¯å¾„ï¼ˆç›¸å¯¹äº chroot çš„è·¯å¾„ï¼‰
        TARGET_DIR="/api_data/lpr"

        echo "ğŸ“‚ ç›®æ ‡ç›®å½•: $TARGET_DIR"
        echo "ğŸ–¥ï¸  æœåŠ¡å™¨: $ECS_USER@$ECS_HOST:$ECS_PORT"

        # ä½¿ç”¨ SCP åŒæ­¥æ–‡ä»¶
        # 1. åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„
        echo "åˆ›å»ºç›®å½•ç»“æ„..."
        scp -P $ECS_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          -r $ECS_USER@$ECS_HOST:$TARGET_DIR /tmp/backup_ 2>/dev/null || true

        # 2. ä¸Šä¼ å®Œæ•´ JSON æ–‡ä»¶
        if [ -f "LPR_Data.json" ]; then
          echo "ğŸ“¤ ä¸Šä¼  LPR_Data.json..."
          scp -P $ECS_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            LPR_Data.json $ECS_USER@$ECS_HOST:$TARGET_DIR/
        fi

        # 3. ä¸Šä¼ å¹´ä»½åˆ†å‰²çš„ JSON æ–‡ä»¶åˆ° yearly_data å­ç›®å½•
        if [ -d "yearly_data" ]; then
          echo "ğŸ“¤ ä¸Šä¼  yearly_data/*.json..."
          scp -P $ECS_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            yearly_data/*.json $ECS_USER@$ECS_HOST:$TARGET_DIR/yearly_data/
        fi

        # 4. æ¸…ç†ç§é’¥
        rm -f ~/.ssh/id_rsa

        echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
        echo "ğŸŒ è®¿é—®åœ°å€: https://casecat.cn/api_data/lpr/"

  # æ¸…ç†æ—§çš„artifactsä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
  cleanup:
    runs-on: ubuntu-latest
    needs: update-lpr-data
    permissions:
      actions: write  # éœ€è¦actionsæƒé™æ¥åˆ é™¤artifacts

    steps:
    - name: Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });

          // ä¿ç•™æœ€æ–°çš„5ä¸ªartifacts
          if (artifacts.data.artifacts.length > 5) {
            const artifactsToDelete = artifacts.data.artifacts.slice(5);

            for (const artifact of artifactsToDelete) {
              console.log(`åˆ é™¤artifact: ${artifact.name}`);
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }
          }

        
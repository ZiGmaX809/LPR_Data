name: Update LPR Data

# å®šæ—¶è¿è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼ˆUTCæ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰
# ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 2 * * *'  # UTCæ—¶é—´æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'lpr_scraper.py'
      - '.github/workflows/update-lpr-data.yml'

jobs:
  update-lpr-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      actions: read    # å…è®¸è¯»å– actions
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Run LPR data scraper
      run: |
        python lpr_scraper.py --force
        
    - name: List generated files
      run: |
        echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la LPR_Data.* || echo "æœªæ‰¾åˆ°LPR_Dataæ–‡ä»¶"
        
        if [ -f "LPR_Data.json" ]; then
          echo "JSONæ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
          head -10 LPR_Data.json
        else
          echo "JSONæ–‡ä»¶æœªç”Ÿæˆ"
        fi
    
    - name: Check for changes
      id: check_changes
      run: |
        # æ·»åŠ æ–°æ–‡ä»¶åˆ°gitè·Ÿè¸ª
        git add LPR_Data.txt LPR_Data.json LPR_Data.csv || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–ï¼ˆåŒ…æ‹¬æ–°æ–‡ä»¶ï¼‰
        if git diff --cached --exit-code --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°å˜åŒ–"
          git diff --cached --name-only
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # æäº¤å˜æ›´ï¼ˆæ–‡ä»¶å·²åœ¨ä¸Šä¸€æ­¥æ·»åŠ ï¼‰
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°LPRæ•°æ® - $BEIJING_TIME"
        
        # æ¨é€åˆ°ä»“åº“
        git push
    
    - name: Upload LPR data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lpr-data-${{ github.run_number }}
        path: |
          LPR_Data.txt
          LPR_Data.json
          LPR_Data.csv
        retention-days: 30
    
    - name: Create release on significant updates
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # æ£€æŸ¥æ˜¯å¦æ˜¯é‡è¦æ›´æ–°ï¼ˆæ¯”å¦‚æ–°å¢äº†æ•°æ®è®°å½•ï¼‰
        if [ -f "LPR_Data.json" ]; then
          RECORD_COUNT=$(python -c "import json; data=json.load(open('LPR_Data.json')); print(len(data['data']))")
          echo "Current record count: $RECORD_COUNT"
          
          # å¦‚æœè®°å½•æ•°é‡æ˜¯5çš„å€æ•°ï¼Œåˆ›å»ºä¸€ä¸ªreleaseï¼ˆå¯é€‰ï¼‰
          if [ $((RECORD_COUNT % 5)) -eq 0 ]; then
            echo "Creating release for milestone: $RECORD_COUNT records"
            # è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºreleaseçš„é€»è¾‘
          fi
        fi

        
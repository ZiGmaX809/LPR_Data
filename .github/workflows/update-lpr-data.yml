name: Update LPR Data

# å®šæ—¶è¿è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼ˆUTCæ—¶é—´å‡Œæ™¨2ç‚¹ï¼‰
# ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 2 * * *'  # UTCæ—¶é—´æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'lpr_scraper.py'
      - '.github/workflows/update-lpr-data.yml'

jobs:
  update-lpr-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
    
    - name: Run LPR data scraper
      run: |
        python lpr_scraper.py --force
    
    - name: Check for changes
      id: check_changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
        if git diff --exit-code --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰LPRæ•°æ®æ–‡ä»¶
        git add LPR_Data.txt LPR_Data.json LPR_Data.csv
        
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # æäº¤å˜æ›´
        git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°LPRæ•°æ® - $BEIJING_TIME" || exit 0
        
        # æ¨é€åˆ°ä»“åº“
        git push
    
    - name: Upload LPR data as artifact
      uses: actions/upload-artifact@v3
      with:
        name: lpr-data-${{ github.run_number }}
        path: |
          LPR_Data.txt
          LPR_Data.json
          LPR_Data.csv
        retention-days: 30
    
    - name: Create release on significant updates
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # æ£€æŸ¥æ˜¯å¦æ˜¯é‡è¦æ›´æ–°ï¼ˆæ¯”å¦‚æ–°å¢äº†æ•°æ®è®°å½•ï¼‰
        if [ -f "LPR_Data.json" ]; then
          RECORD_COUNT=$(python -c "import json; data=json.load(open('LPR_Data.json')); print(len(data['data']))")
          echo "Current record count: $RECORD_COUNT"
          
          # å¦‚æœè®°å½•æ•°é‡æ˜¯5çš„å€æ•°ï¼Œåˆ›å»ºä¸€ä¸ªreleaseï¼ˆå¯é€‰ï¼‰
          if [ $((RECORD_COUNT % 5)) -eq 0 ]; then
            echo "Creating release for milestone: $RECORD_COUNT records"
            # è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºreleaseçš„é€»è¾‘
          fi
        fi

        